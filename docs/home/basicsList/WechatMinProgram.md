---
title: 小程序前世今生
sidebar: false
date: '2020-12-07'
tag: # 页面的标签 
  - WeChatMinProgram
# 一些 meta 标签, 可以用于被搜索引擎爬取
meta:
  - name: description
    content: 小程序前世今生 笔记 
  - name: keywords # keywords 标签, 在页内搜索时会被查询
    content: 小程序前世今生 Javascript WeChatMinProgram 基础笔记
# prev: ./TypeScript笔记
next: ./TypeScript笔记
---
# 小程序的前世今生

## 微信小程序技术发展史
微信小程序的发展目前用户最多，发展最早。小程序并非凭空冒出来的一个概念。从技术的发展角度来看，微信小程序是从微信中的 webView 和 JS-SDK 进化到了今天的形态。

2016年初，张小龙在微信公开课上宣布微信将推出“应用号”。

2017年1月9日，“应用号”以“小程序”的新名称正式推出。

到如今，各大平台纷纷加入 小程序 队伍，比如：微信、企业微信、QQ、支付宝、高德地图、手机淘宝、百度、百度贴吧、百度地图、今日头条、抖音......

下面通过一些介绍和对比，让我们了解这个发展迅猛的应用。

## JS-SDK
在微信中，WebView 是一个重要的移动端网页的入口，微信就提供了相关的 JS API 调用原生组件功能，2015年，微信发布了一套网页工具包 JS-SDK，开放了拍摄、录音、语音识别、二维码、地图、支付、分享、卡券等几十个API。让用户在微信网页中可以完成之前不能或者很难做到的事情。

JS-SDK 解决了移动端网页的一些问题，目前主要用于 微信公众号网页，JS-SDK 并没有解决移动端体验不佳的问题，在浏览器中渲染页面之前会有一个白屏的过程，在移动端，受限于设备性能和网络速度，白屏会更加明显。

### 微信小程序的目标
在它的官方文档中解释：
- 快速的加载
- 更强大的能力
- 原生的体验
- 易用且安全的微信数据开放
- 高效和简单的开发

## 小程序和 HTML5（以下简称H5） 网页的区别
- 运行环境：小程序基于浏览器内核重构内置解析器，H5 依赖于宿主环境--浏览器。

- 系统权限：小程序能获得更多的系统权限，比如网络通信、设备控制（蓝牙、WIFI等）、数据缓存能力、 原生组件交互等。

- 渲染机制：小程序的逻辑层和渲染层是分开的，分别运行在不同的线程中；H5 页面渲染线程和 Javascript 脚本执行线程是互斥的，在单线程中，这也是为什么长时间的脚本运行可能会导致页面失去响应。

- 因为小程序的逻辑层和渲染层是分开的，逻辑层运行在 JSCore 中，并没有一个完整的浏览器对象，因此没有 DOM 、BOM API。前端常用的 JQuery、Zepto 等一些库不能在小程序使用，同时 JSCore 环境和 NodeJS 环境也有一些差别，所以一些 NPM 包也不能使用。

- 面对的环境：网页要面对各式各样的浏览器环境，PC 端要面对 IE、Chrome、火狐、Safari 等浏览器，移动端面对 Safari、Chrome 和 Android、IOS系统中的 WebView；小程序在开发中面对是 Android、IOS 的微信客户端、小程序开发者工具。

根据微信小程序文档，小程序的三大运行环境也有所区别：
| 运行环境        | 逻辑层          | 渲染层    |
|:--------------- |:-------------- |:--------- |
| IOS             | JavaScriptCore | WKWebView |
| 安卓            | X5 JSCore| X5浏览器         |
| 小程序开发者工具 | NWJS     | Chrome WebView  |

所以微信小程序介于 web 端和原生 App 之间，能够丰富调用功能接口，同时又跨平台。

## 小程序的构成
通过中开发者工具中快速构成一个项目，可以发现一个应用的主要组成：
- .json 配置文件，app.json 主要配置所有页面路径、界面表现、网络超时时间、底部 tab 等；页面目录中的 .json 主要配置顶部样式、标题、是否刷新等。
- .wxml 文件，类型网页中的 HTML，构建页面结构。
- .wxss 文件，具有大部分 CSS 特性，新增了尺寸单位 rpx，解决移动端网页开发中适配的问题，提供了全局的样式和局部样式。
- .js 文件，脚本逻辑文件

小程序采用 MVVM 开发模型，比如 Vue、React 也是采用这种模式，双向数据绑定，渲染和逻辑层分离，不直接用 JS 操作DOM，JS 只负责管理状态，通过模板 `{{}}` 语法去描述状态和界面结构关系。

## 小程序架构
小程序运行环境分为渲染层和逻辑层，WXML 模板、WXSS 样式工作在渲染层，JS 脚本工作在逻辑层。

小程序的渲染层和逻辑层由两个线程管理：
- 页面使用 WebView 渲染，一个小程序存在多个界面，所以渲染层存在多个 WebView 线程
- 逻辑层采用 JsCore 线程运行 JS 脚本

这两个线程的通信通过系统层的 WeixinJsBridage（JS-SDK 是对 WeixinJsBridage 的包装）进行通信，逻辑层把数据变化通知到视图层，触发视图层页面更新，视图层把触发的事件通知到逻辑层进行业务处理；逻辑层发送网络请求也经由Native转发。

::: tip MVVM
页面渲染的具体流程是：在渲染层，宿主环境会把 WXML 转化成对应的 JS 对象，在逻辑层发生数据变更的时候，我们需要通过宿主环境提供的 setData 方法把数据从逻辑层传递到渲染层，再经过对比前后差异，把差异应用在原来的Dom树上，渲染出正确的UI界面
:::

通信模型如图：

![通信模型图片](https://res.wx.qq.com/wxdoc/dist/assets/img/4-1.ad156d1c.png)

###### *图片来自微信[小程序文档](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/framework.html#%E6%B8%B2%E6%9F%93%E5%B1%82%E5%92%8C%E9%80%BB%E8%BE%91%E5%B1%82)*

缺点是带来了无处不在的异步问题（任何数据传递都是线程间的通信，也就是都会有一定的延时），不过小程序在框架层面已经封装好了异步带来的时序问题。


### 组件系统
小程序有自己的组件的，这些基本组件就是基于 Exparser 框架，也支持自定义组件，用法和组件间通信类似于 Vue。

在内置组件中，有些原生组件，不完全是 Exparser 框架下渲染，由客户端原生参与组件的渲染。比如说 Map 组件。它渲染的层级比在 WebView 层渲染的普通组件要高。

## 运行机制
微信客户端在打开小程序之前，会把整个小程序代码下载到本地，然后通过 app.json 的 pages 字段就可以知道你当前小程序的所有页面路径。

### 启动分为两种：
- 热启动，假如用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时无需重新启动，只需将后台态的小程序切换到前台，这个过程就是热启动；
- 用户首次打开或小程序被微信主动销毁后再次打开的情况，此时小程序需要重新加载启动，即冷启动。

### 销毁
只有当小程序进入后台一定时间，或者系统资源占用过高，才会被真正的销毁。

### 更新
开发者在后台发布新版本之后，无法立刻影响到所有现网用户，但最差情况下，也在发布之后 24 小时之内下发新版本信息到用户。

小程序每次冷启动时，都会检查是否有更新版本，如果发现有新版本，将会异步下载新版本的代码包，并同时用客户端本地的包进行启动，即新版本的小程序需要等下一次冷启动才会应用上；也可以使用 `wx.getUpdateManager` 检查更新功能。

###### *以上内容，部分参考[博客](https://www.cgtblog.com/wx/3579.html) 和 [小程序文档](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%80%E6%9C%AF%E5%8F%91%E5%B1%95%E5%8F%B2)*

## 小程序生态
微信利用自身的高频/高黏性的优势，制造小生态：定制标准，开放入驻，利用微信作为天然的传播媒介，分发/分享小程序。


# 小程序之外的技术
## 快应用
快应用也叫免安装应用。主流手机厂商利用系统优势，联合统一定义轻应用的标准，统一接入，即点即用，无需安装下载。比如小米的“直达服务”，华为的“快应用”。实质上也不是新鲜事物，类似微信小程序。小微信程序和轻应用能解决低频，单一业务需求的使用场景，重度使用不够友好。

使用前端技术栈开发，原生渲染，具备 H5 页面和原生应用的优点。即点即用，拥有原生应用的性能体验，可将应用添加主屏幕桌面。

我觉得小程序 和 快应用都是在 PWA 的基础上开发的拥有更强能力的应用，我新建的 PWA 应用在“快应用”列表中也是可以看到和打开的。

## PWA（Progressive Web App 渐进式网页应用）
PWA是 Google 在 2015 年提出，2016年6月才推广的项目。是结合了一系列现代Web技术的组合，在网页应用中实现和原生应用相近的用户体验。

它有几个特点：
- PWA 可以添加到系统主屏幕上，不用从应用商店下载，通过 Manifest file 提供类似 App 上的使用体验，在 Android 上可以全屏显示；不支持 Safari，所以 IOS 不可以使用

- 用户从主屏幕启动时，不用考虑网络状态，可以立即加载出来

- 支持推送通知

### PWA关键技术
- Service Worker，以下简称 SW，是指离线缓存文件，SW 作用于浏览器和服务器之间，相当于一个代理服务器，只能在 HTTPS 环境下使用 SW，因为 SW 的权利比较大，能够直接截取和返回用户的请求，所以要考虑一下安全性问题。

- Manifest，一个 JSON 配置文件，能够配置应用的 横竖屏显示，定义启动动画，启动页面的 URL 地址，添加到主屏幕上的应用程序图标、名字、图标大小等。

- Push Notification，Push 和 Notification 是两个不同的功能，涉及到两个API；Push 和 Notification 关系，Push 是服务器将更新的信息传递到 SW，Notification 是浏览器发送的通知消息，SW 将更新的信息推送给用户。

## 快应用和 PWA 应用的区别